<html>
  <head>
    <title>Distractacator</title>
    <style>
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
      }

      .gif {
        position: absolute;
      }

      .gif img {
        position: absolute;
      }

      #current-time {
        position: relative;
        z-index: 10;
        font-weight: bold;
        font-family: 'Helvetica';
      }
    </style>
    <style id="levels"></style>
  </head>
  <body>
    <div id="current-time"></div>
    <div id="img0" class="gif"><img/></div>
    <div id="img1" class="gif"><img/></div>
    <div id="img2" class="gif"><img/></div>
    <div id="img3" class="gif"><img/></div>
    <div id="img4" class="gif"><img/></div>
    <div id="img5" class="gif"><img/></div>
    <div id="img6" class="gif"><img/></div>
    <div id="img7" class="gif"><img/></div>
  </body>
  <script>
    /* TODO:
      levels:
        0 blank
        1 1 full screen image
        2 1 partial image
        3 1 color + 1 partial image
        4 2 colors + 1 partial image
        5 2 colors + 1 partial image

      sequence:
        16-8 minutes:
          level 1-0, period 30secs - 5 secs
        8-4 minutes:
          level 1, period 5-secs to 1 sec
        4-2 minutes:
          sequence 1-3, period 4 sec
        2-1
          sequence 1-4, period 4 sec
        1-0
          sequence 1-5, period 4 sec
      test controls
      Visualize
      Move to nexus 7.
     */

    var SECONDS = 1000, MINUTES = 60*SECONDS, HOURS=60*MINUTES, DAYS=24*HOURS;
    var TIME_HORIZON = 7 * DAYS;
    var OVERLAP_INTERVAL = 2 * MINUTES;
    var RECHECK_INTERVAL = 60 * SECONDS;
    var SALT = ("anime,funny,rocket,robot,nasa,geometry,math,lol,cat,trippy,awesome,nerd,code,design,strange,"
             + "architecture,tech,horror,bunny,star wars,dr who,matrix,laser,space,dance,explosion,"
             + "visualization").split(',');

    var requestID = 0;
    var schedule = [];
    var animationTimeout;
    var currentEvent;
    var scriptStart = new Date();
    var imgDivs = Array.prototype.slice.call(document.querySelectorAll('.gif'),0);
    var imgs = Array.prototype.slice.call(document.querySelectorAll('.gif img'),0);

    function load() {
      gapi.auth.authorize({
          client_id:'102686879623-2b4o25tr4df1h4huf09nhdpcgs4hs84c.apps.googleusercontent.com',
          immediate: false,
          scope: 'https://www.googleapis.com/auth/calendar.readonly'
        }, authenticated);
    }

    function authenticated() { 
      gapi.client.load('calendar','v3', startCalendarUpdates);
    }

    function startCalendarUpdates() {
      requestCalendars();
      setInterval(requestCalendars, RECHECK_INTERVAL);
    }

    function requestCalendars() {
      gapi.client.calendar.calendarList.list().execute(withCalendars);

      function withCalendars(resp) {
        requestEvents(resp.result.items.map(function(c) { return c.id }));
      }
    }

    function choose(a,n) {
      if (n<1 || a.length < 1) return [];
      var next = a.slice(0);
      return next.splice((Math.random()*a.length)|0,1).concat(choose(next,n-1));
    }

    function requestEvents(calendarIds) {
      calendarIds.reduce( function(next,id) { return function(events) {
        gapi.client.calendar.events.list({
          calendarId:id,
          timeMin:new Date().toISOString(), 
          timeMax:new Date(new Date().getTime() + TIME_HORIZON).toISOString(), 
          orderBy:'startTime', 
          singleEvents:true
        }).execute(function(resp) {
          next(events.concat(resp.result.items||[]));
        })
      }}, reschedule)([]);
    }

    function reschedule(events) {
      events = events.filter(function(e) { return e.start && e.start.dateTime; });
      events.sort(function(a,b) { return eventStart(a).getTime() - eventStart(b).getTime(); });
      schedule = events;
      animate();
    }

    function eventStart(event) { return new Date(event.start.dateTime); }

    function animate() {
      clearTimeout(animationTimeout);
      updateSchedule();
      document.getElementById('current-time').innerHTML = (currentEvent||{}).summary + ' (' +currentTime() +')';

      document.getElementById('levels').innerHTML = choose([0,1,2,3,4,5,6,7],8).map(
        function(d,i) { return scene(imgDivs[d],imgs[d],i) }).join('\n'); 

      animationTimeout = setTimeout(animate, 2*SECONDS);
    }

    function scene(imgDiv, img, index) {
      var style = {};
      var dims = fill(document.body.offsetWidth, document.body.offsetHeight, img.width, img.height);
      style['#'+imgDiv.id] = {top:0,left:0,bottom:0,width:'100%','z-index':(8-index)};
      style['#'+imgDiv.id + ' img'] = {
        width:dims.w+'px', 
        height:dims.h+'px',
        transform:'translate('+dims.x+'px,'+dims.y+'px)'
      };
      return toCSS(style);
    }

    function toCSS(obj) {
      var css = '';
      for (var key in obj) {
        css += key + (typeof obj[key] === 'object'
          ? ' {\n' +  toCSS(obj[key]) + '}\n\n'
          : ': ' + obj[key] + ';\n');
      }
      return css;
    }

    function updateSchedule() {
      while (schedule[0] && new Date(schedule[0].start.dateTime) < currentTime()) schedule.splice(0,1);
      if ( ! currentEvent || currentEvent.summary != (schedule[0]||{}).summary ) {
        currentEvent = schedule[0];
        currentEvent ? fetchImages(currentEvent) : renderImages([]);
      }      
    }

    function fetchImages(event) {
      var salt = choose(SALT,2);
      var cleanSummary = event.summary.replace(/\W/g,' ').replace(/\s+/g,' ').split(' ');
      var query = choose(salt.concat(cleanSummary),5).join(' ');
      console.log(query);
      imageRequest(query, renderImages);
    }

    function renderImages(imageURLs) {
      var selectedImages = choose(imageURLs,8);
      imgs.forEach(function (img, i) { img.setAttribute('src', selectedImages[i] || ''); });
    }

    function imageRequest(query, cb) {
      var url = 'http://ajax.googleapis.com/ajax/services/search/images'
      var query = 'v=1.0&rsz=8&imgtype=animated&q='+encodeURIComponent(query)
      jsonpRequest(url+'?'+query, function(r) {
        cb((r.responseData||{results:[]}).results.map(function(i) { return i.url; })); 
      });
    }

    function fill( ww, wh, iw, ih ) {
      var scale = Math.min(ww/iw,wh/ih);
      return {x:(ww-iw*scale)/2, y:(wh-ih*scale)/2, w:iw*scale, h:ih*scale};
    }

    function currentTime() {
      return new Date(scriptStart.getTime() +2*DAYS + 60 * (new Date().getTime() - scriptStart.getTime()));
    }

    function jsonpRequest(url,cb) {
      var request = 'jsonp_request_'+(requestID++);
      var responseHandler = request+'_handler';

      window[responseHandler] = function(response) {
        delete window[responseHandler];
        document.getElementById(request).remove();
        cb(response);
      }

      var script = document.createElement('script');
      script.setAttribute('src', url + (url.match(/\?/) ? '&':'?') + 'callback='+responseHandler);
      script.id = request;
      document.body.appendChild(script);
    }
  </script>
  <script src="https://apis.google.com/js/client.js?onload=load"></script>
<html>